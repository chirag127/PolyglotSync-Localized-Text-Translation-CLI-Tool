# GitHub Actions CI Workflow

# This workflow will do a clean install of dependencies,
# run the tests, and lint the code.
# For more information see: https://docs.github.com/en/actions/automating-build-with-github-actions/about-continuous-integration-and-continuous-delivery-with-github-actions

name: CI

# Controls when the workflow will run
# Runs on pull request push events, and on scheduled runs
on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]
  schedule:
    # Run every day at 03:00 UTC
    - cron: '0 3 * * *'

# A workflow run is made up of one or more jobs that can run sequentially or in parallel
jobs:
  # Define a job to run tests and linting
  build_and_test:
    # The type of runner that the job will run on
    runs-on: ubuntu-latest

    # Set strategy for matrix builds if needed (e.g., multiple Python versions)
    strategy:
      matrix:
        python-version: ["3.10", "3.11", "3.12", "3.13"]

    # Steps represent a sequence of tasks that will be executed as part of the job
    steps:
      # Checks-out your repository into the workspace, allowing you to access it.
      - name: Checkout Repository
        uses: actions/checkout@v4

      # Set up Python environment
      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
          cache: 'uv' # Use uv for caching dependencies

      # Install dependencies using uv
      - name: Install Dependencies with uv
        run: |
          python -m pip install --upgrade pip
          uv pip install --frozen uv_lock.toml --system # Assuming uv_lock.toml exists for reproducibility
          # If uv_lock.toml does not exist or you want to install from pyproject.toml:
          # uv pip install --system --editable . # Installs the project itself in editable mode

      # Run linters and formatters with Ruff
      - name: Run Ruff (Lint & Format)
        run: |
          uv pip install ruff # Ensure ruff is installed if not in lock file
          ruff check . --output-format=github
          ruff format --check . --output-format=github

      # Run tests with Pytest
      - name: Run Pytest
        run: |
          uv pip install pytest # Ensure pytest is installed if not in lock file
          pytest --cov=./ --cov-report=xml

      # Upload coverage reports
      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v4
        env:
          CODECOV_TOKEN: ${{ secrets.CODECOV_TOKEN }}
        with:
          files: ./coverage.xml
          fail_ci_if_error: true # fail step if there are errors
